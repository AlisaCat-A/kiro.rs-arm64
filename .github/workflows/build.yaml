name: Build for Oracle Linux ARM64 (Strict Compatibility)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label'
        required: true
        default: '2026.1.1'

jobs:
  build-in-container:
    # 必须在 ARM64 运行器上跑，以匹配你的服务器架构
    runs-on: ubuntu-24.04-arm
    
    # 核心：直接在 Oracle Linux 8 容器内运行所有步骤
    container:
      image: oraclelinux:8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 在容器内安装旧版系统所需的开发工具
      - name: Install System Dependencies
        run: |
          dnf groupinstall -y "Development Tools"
          dnf install -y openssl-devel perl-core nodejs npm

      # 2. 构建前端 (容器内)
      - name: Build admin-ui
        working-directory: admin-ui
        run: |
          npm install
          npm run build

      # 3. 安装 Rust (针对容器环境)
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # 4. 编译后端
      # 此时不再需要 musl，也不需要特意设置静态，因为环境已经完全一致
      - name: Build app
        run: |
          source $HOME/.cargo/env
          cargo build --release

      # 5. 上传产物
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: kiro-rs-oracle-linux-8-arm64
          path: target/release/kiro-rs
