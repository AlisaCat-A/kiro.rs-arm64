name: Build for Oracle Linux ARM64 (Strict Compatibility)

on:
  push:
    tags:
      - 'v*'
      - '20*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label'
        required: true
        default: '2026.1.1'

jobs:
  build-in-container:
    # 必须在 ARM64 运行器上跑，以匹配你的服务器架构
    runs-on: ubuntu-24.04-arm
    
    # 核心：直接在 Oracle Linux 8 容器内运行所有步骤
    container:
      image: oraclelinux:8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 安装旧版系统开发工具，并升级 Node.js
      - name: Install System Dependencies
        run: |
          # 启用 Node.js 20 模块（Oracle Linux 8 官方支持）
          dnf module enable -y nodejs:20
          dnf groupinstall -y "Development Tools"
          dnf install -y openssl-devel perl-core nodejs
          
          # 验证版本
          node -v  # 应该显示 v20.x.x

      # 2. 构建前端 (现在的 Node 环境可以跑 tsc 和 vite 了)
      - name: Build admin-ui
        working-directory: admin-ui
        run: |
          # 如果项目有用 pnpm，这里安装一下；如果没有，就用 npm
          npm install -g pnpm || true
          pnpm install || npm install
          pnpm run build || npm run build

      # 3. 安装 Rust (针对容器环境)
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # 4. 编译后端
      # 此时不再需要 musl，也不需要特意设置静态，因为环境已经完全一致
      - name: Build app
        run: |
          source $HOME/.cargo/env
          cargo build --release

      # 5. 上传产物
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: kiro-rs-oracle-linux-8-arm64
          path: target/release/kiro-rs
